pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

function newenemy()
	add(enemies, {
		x = 128+rnd(32),
		y = rnd(100)+10,
		sprite = flr(4+rnd(3)),
		vx = -1-rnd(1),
		vy = rnd(4)-2,
		hp = 100,
		flicker = 0,
		death = -1,
	})
end

function reset()

	bullettimer=0
	next_enemy=10
	difficulty=30
	score=0
	finish=false


	player={
		x=14,
		y=64,
		s=3,
		vx=0,
		vy=0,
		sprite=1,
		hp=100
	}

	bullets={}
	enemies={}
	
	for i=1,10 do
		newenemy()	
	end
	
end

stars={}
function _init()

	reset()

	for i=1,50 do
		add(stars,{x=rnd(128),y=rnd(128)})
	end

end

function distance(a,b)
	local dx=a.x-b.x
	local dy=a.y-b.y
	return sqrt(dx*dx+dy*dy)
end

function _update()
	
	if finish then
		if btnp(5) then
			reset()
		end
		return
	end
	
	player.sprite=1
	local speed=1
	if btn(4) then
		speed=0.5
	end
	if btn(2) then
		player.vy-=speed
		player.sprite=2
	end
	
	if btn(3) then
		player.vy+=speed
		player.sprite=3
	end
	
	if btn(4) and bullettimer<=0 then
		add(bullets, {
			x=player.x-2,
			y=player.y,
			vx=3,
			vy=player.vy*0.2,
			s=3
			})
		bullettimer=3
	end

	if bullettimer>0 then
		bullettimer-=1
	end

	
	-- move bullets
	for n in all(bullets) do
		b.x+=b.vx
		b.y+=b.vy
		if b.y>140 or b.y<-20 or b.x>140 or b.x<-20 then
			del(bullets,b)
		end
	end

	-- hit enemies
	for e in all(enemies) do
		for b in all (bullets) do
			local d = distance(e,b)
			if e.death<0 and d<5 then
				e.hp-=23+rnd(15)
				e.flicker=6
				del(bullets, b)
			end
		end
	end

	-- move enemies
	for e in all(enemies) do
		if e.death>=10 then
			del(enemies, e)
		elseif e.death>=0 then
			e.death+=1
		elseif e.hp<=0 then
			e.death=0
			score+=10
		else
			e.x+=e.vx*0.3
			e.y+=e.vy*0.3
			if e.y<10 then
				e.vy=-e.vy
				e.y=10
			end
			if e.y>118 then
				e.vy=-e.vy
				e.y=118
			end
			if e.x<10 then
				e.death=0
				player.hp-=8
			end
		end
		if e.flicker>0 then
			e.flicker-=1
		end
	end

	player.vy*=0.8	
	--player.vy=max(-3, min(3, player.vy))
	player.y+=player.vy
	player.y=max(5, min(123, player.y))
	if player.hp<=0 then
		player.hp=0
		finish=true
	end
	
	next_enemy-=1
	if next_enemy<0 then
		newenemy()
		next_enemy=difficulty+rnd(difficulty)
		difficulty*=0.98
		difficulty=max(difficulty, 5)
	end
end

function paralax(x,y,px,py,scroll)
	local cur=scroll%256
	map(px,py,-cur-128+x,y,32,8)
	map(px,py,-cur+128+x,y,32,8)
end

scroll1=0
scroll2=0
scroll3=0
scroll4=0
function _draw()


	cls(0)
	
	if finish then
		for i=1,#stars do
			local cur=stars[i]
			circfill((cur.x-scroll4)%128, cur.y, 8, 8+cur.x%3)
		end
		scroll4+=0.5
		
		rectfill(32,64,96,80,1)
		print("score:"..score,40,70,7)
		
		return	
	end
	
	for i=1,#stars do
		local cur=stars[i]
		pset((cur.x-scroll4)%128, cur.y, 5)
	end
	
	paralax(16,64,0,8,scroll1)
	paralax(0,64,0,8,scroll2)
	paralax(0,64,0,0,scroll3)
	scroll1+=0.5
	scroll2+=0.8
	scroll3+=1
	scroll4+=0.3
	
	line(8,0,8,128,1)
	
	for e in all(enemies) do
		if e.death<0 then
			if e.flicker%2==1 then
				pal(5,7)
			end
			spr(e.sprite, e.x-3.5, e.y-3.5)
			pal()
		else
			for j=1,5 do
				circfill(e.x-rnd(8),e.y-rnd(8),e.death, 8+j%3)
			end
		end
	end
	
	for b in all(bullets) do
		line(b.x, b.y, b.x+b.vx, b.y+b.vy, 8)
	end
	
	spr(player.sprite,player.x-3.5,player.y-3.5)
	--circfill(player.x,player.y,player.s, 8)
	
	print("hp "..player.hp,10,1,11)
	print(score,96,1,8)
	
end
__gfx__
00000000000000000000000000500000005555000005550000555500000000000000000000000000000000000000000000000000000000000000000000000000
00000000500000000000001505650000054444500054445005444450000000000000000000000000000000000000000000000000000000000000000000000000
00700700550000000000011555665000544244450544245054242445000000000000000000000000000000000000000000000000000000000000000000000000
00077000565551100005556556665000544442455444444554444445000000000000000000000000000000000000000000000000000000000000000000000000
00077000566666655555666556666510524444255424242552444425000000000000000000000000000000000000000000000000000000000000000000000000
00700700566665500566665005666611524444255244442505244225000000000000000000000000000000000000000000000000000000000000000000000000
00000000056550000056650000555665052222500522225000522550000000000000000000000000000000000000000000000000000000000000000000000000
00000000055000000055500000000555005555000055550000055000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55005050555000000000000012222100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
515d5150555000000000000012222211000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555055500000000012222221000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55151555555055500000000012222221111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555d51555055500000000012222221122210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
155d5555555055500000000012222221122210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55155155555055500000000012222221122210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55d555d5000000000000000012222221122210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55551555000000000000000012222221122210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5d515d55055000000000000012222221122211110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555551055000000000000012222221122212210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55d5d555055055500000000012222221122212210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555d55055055500000000012222221122212210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
51515555055055500000000012222221122212210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55d55d55055055500000000012222221122212210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555000000000000000012222221122222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55155155000000000000000012222221122222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555000555500000000011111221122221110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d555d555000555500000000022221221122221220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55d55551000555500000000022221111112221220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55515555055555500000000022221222212221220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555d55055555500000000022221222212221220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55d55555055555500000000022221222212221220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000010000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000100000000000000000100000000000000000000000000020000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000200000001000000000200010000010000000100000000030000000001020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000301000002000001000300030000030100000302000000020001100002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100202000003000002000200020000020300000302000000030002021102020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2021303011212031113031302120112130201121203031113120112020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000013000000230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1300000013000000000013000000000023000000230000000000001300001400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2314000023130014000023000000000023000000231400000000002300142300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2324000023230023000023000000000023001400232400001300002300242300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323141423332423141423001300242423142414232300132300142313232313000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3323242434333423243323143413343323333334343314342314242333232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
